<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valentine?</title>

  <style>
    :root{
      --pink1:#ffd1dc;
      --pink2:#ff7aa2;
      --card:rgba(255,255,255,.78);
      --text:#2b2b2b;
      --shadow: 0 20px 60px rgba(0,0,0,.16);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      overflow:hidden;
      background:radial-gradient(circle at 20% 20%, var(--pink1), var(--pink2));
    }

    /* Background blobs */
    .bg{position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden;}
    .blob{
      position:absolute;
      width:55vmax; height:55vmax;
      border-radius:50%;
      filter:blur(50px);
      opacity:.45;
      mix-blend-mode:screen;
      animation:drift 16s ease-in-out infinite alternate;
    }
    .blob.one{
      left:-15vmax; top:-20vmax;
      background:radial-gradient(circle at 30% 30%, #fff, #ffc0d0 60%, transparent 70%);
      animation-duration:18s;
    }
    .blob.two{
      right:-20vmax; bottom:-20vmax;
      background:radial-gradient(circle at 30% 30%, #fff, #ff8fb1 60%, transparent 70%);
      animation-duration:22s;
    }
    .blob.three{
      left:25vmax; bottom:-30vmax;
      background:radial-gradient(circle at 30% 30%, #fff, #ffd1dc 60%, transparent 70%);
      animation-duration:20s;
    }
    @keyframes drift{
      from{transform:translate(0,0) scale(1);}
      to{transform:translate(8vmax,-6vmax) scale(1.05);}
    }

    /* Floating hearts + cute emojis */
    .floaties{position:fixed; inset:0; z-index:1; pointer-events:none; overflow:hidden;}
    .floaty{
      position:absolute;
      opacity:.72;
      filter:drop-shadow(0 8px 14px rgba(0,0,0,.08));
      animation: floatUp linear infinite;
      will-change:transform;
      user-select:none;
    }
    @keyframes floatUp{
      from{transform:translateY(110vh) translateX(0) rotate(0deg);}
      to{transform:translateY(-15vh) translateX(var(--drift)) rotate(360deg);}
    }
    body.party .floaty{
      animation-duration: calc(var(--dur) * .55);
      opacity: .9;
    }

    /* Confetti canvas */
    canvas#confetti{position:fixed; inset:0; z-index:3; pointer-events:none;}

    /* Main card */
    .card{
      z-index:2;
      width:min(760px, 92vw);
      padding:34px 26px 28px;
      border-radius:26px;
      background:var(--card);
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow);
      text-align:center;
      position:relative;
    }

    /* Top bar */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
      flex-wrap: wrap;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.7);
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
      border:0;
    }
    .pill.muted{font-weight:700;}
    .pill.btn{
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
    }
    .pill.btn:hover{ transform: translateY(-1px); filter: brightness(1.03); }

    /* Teddy */
    .bear{
      font-size:clamp(56px, 8vw, 92px);
      line-height:1;
      margin: 4px 0 10px;
      display:inline-block;
      animation:bearBounce 1.6s ease-in-out infinite;
      transform-origin:50% 80%;
      filter:drop-shadow(0 16px 25px rgba(0,0,0,.10));
    }
    @keyframes bearBounce{
      0%,100%{transform:translateY(0) rotate(-1deg);}
      50%{transform:translateY(-10px) rotate(1deg);}
    }
    body.party .bear{animation: bearParty .6s ease-in-out infinite;}
    @keyframes bearParty{
      0%,100%{transform:translateY(0) rotate(-4deg) scale(1.02);}
      50%{transform:translateY(-8px) rotate(4deg) scale(1.06);}
    }

    h1{
      margin:0 0 16px;
      font-size:clamp(22px, 4vw, 34px);
      line-height:1.18;
      font-weight:900;
      letter-spacing:-.02em;
    }
    .sub{
      margin: 0 0 6px;
      font-size: 15px;
      opacity: .85;
      font-weight: 650;
    }

    /* Buttons area */
    .buttons{
      margin-top:18px;
      display:flex;
      gap:16px;
      justify-content:center;
      align-items:center;
      position:relative;
      height:110px;
    }
    button{
      border:0;
      padding:14px 22px;
      border-radius:999px;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .12s ease;
      box-shadow:0 10px 25px rgba(0,0,0,.14);
      user-select:none;
      touch-action:manipulation;
    }
    #yesBtn{ background:#22c55e; color:#fff; }
    #yesBtn:hover{transform:translateY(-2px); filter:brightness(1.05);}

    #noBtn{
      background:#ef4444;
      color:#fff;
      position:absolute;
      top:26px;
      left:calc(50% + 120px);
      transform: scale(1);
      transform-origin:center;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      z-index:5;
      background:rgba(17,24,39,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
      font-size:14px;
      box-shadow:0 20px 70px rgba(0,0,0,.25);
      display:none;
      max-width:min(92vw, 680px);
      text-align:center;
    }
    .toast.show{display:block; animation:toastIn .22s ease-out;}
    @keyframes toastIn{
      from{transform:translateX(-50%) translateY(10px); opacity:.0;}
      to{transform:translateX(-50%) translateY(0); opacity:1;}
    }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background:rgba(0,0,0,.45);
      padding:22px;
      z-index:4;
    }
    .modal{
      width:min(760px, 92vw);
      background:#fff;
      border-radius:22px;
      padding:22px;
      text-align:center;
      box-shadow:0 25px 80px rgba(0,0,0,.25);
    }
    .modal h2{
      margin:0 0 10px;
      font-size:clamp(22px, 4vw, 30px);
    }
    .modal p{
      margin:0 0 14px;
      font-size:17px;
      opacity:.92;
      font-weight:650;
    }

    .modalGrid{
      display:grid;
      gap:14px;
      grid-template-columns: 1.1fr .9fr;
      align-items:stretch;
    }
    @media (max-width: 780px){
      .modalGrid{grid-template-columns:1fr; }
    }

    /* Polaroid */
    .polaroid{
      background:#fff;
      border-radius:18px;
      padding:12px 12px 16px;
      box-shadow:0 15px 40px rgba(0,0,0,.12);
      border:1px solid rgba(0,0,0,.06);
      text-align:left;
    }
    .polaroid img{
      width:100%;
      height:260px;
      object-fit:cover;
      border-radius:14px;
      display:block;
      background:linear-gradient(135deg, #ffe6ee, #ffd1dc);
    }
    .caption{
      margin:10px 6px 0;
      font-weight:900;
      letter-spacing:-.01em;
    }

    /* Scratch card */
    .scratchWrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 15px 40px rgba(0,0,0,.12);
      border:1px solid rgba(0,0,0,.06);
      background:linear-gradient(135deg, #fff, #fff5f8);
      padding:14px;
      text-align:left;
      min-height: 320px;
    }
    .secretTitle{ font-weight:950; font-size:18px; margin:0 0 6px; }
    .secretText{
      margin:0;
      font-weight:750;
      opacity:.9;
      line-height:1.4;
      padding-right: 4px;
    }
    .hint{
      margin:10px 0 0;
      font-size:13px;
      font-weight:800;
      opacity:.7;
    }
    #scratchCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      cursor:grab;
      touch-action:none;
    }
    .scratchDone{
      position:absolute;
      left:14px;
      right:14px;
      bottom:14px;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      color:#14532d;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      display:none;
      z-index: 1;
    }

    /* Love letter overlay */
    .envelopeOverlay{
      position:absolute;
      inset:0;
      z-index:2;
      display:grid;
      place-items:center;
      background:linear-gradient(135deg, rgba(255,255,255,.86), rgba(255,245,248,.86));
      backdrop-filter: blur(3px);
      cursor:pointer;
      user-select:none;
      padding: 16px;
      transition: opacity .35s ease, transform .35s ease;
    }
    .envelopeOverlay.gone{
      opacity:0;
      pointer-events:none;
      transform: scale(1.02);
    }

    .env{
      width:min(320px, 86%);
      aspect-ratio: 16/11;
      position:relative;
      border-radius:18px;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.12));
    }
    .envBack{
      position:absolute; inset:0;
      border-radius:18px;
      background:linear-gradient(135deg, #fff, #ffe6ee);
      border:1px solid rgba(0,0,0,.06);
      z-index:0;
    }
    .envBody{
      position:absolute; inset:0;
      border-radius:18px;
      overflow:hidden;
      z-index:1;
    }
    .envBody:before,
    .envBody:after{
      content:"";
      position:absolute;
      inset:auto 0 0 0;
      height: 75%;
      background:linear-gradient(135deg, #ffd1dc, #fff);
      clip-path: polygon(0 100%, 50% 38%, 100% 100%, 100% 100%, 0 100%);
      opacity:.95;
    }
    .envBody:after{
      height: 78%;
      opacity:.55;
      transform: translateY(6px);
      filter: blur(0.2px);
    }
    .envFlap{
      position:absolute;
      left:0; right:0; top:0;
      height: 62%;
      background:linear-gradient(135deg, #fff, #ffd1dc);
      border-radius:18px;
      clip-path: polygon(0 0, 100% 0, 50% 85%);
      transform-origin: 50% 0%;
      transform: rotateX(0deg);
      transition: transform .65s ease;
      border-top:1px solid rgba(0,0,0,.05);
      z-index:3;
    }
    .envelopeOverlay.opened .envFlap{
      transform: rotateX(180deg);
    }
    .envSeal{
      position:absolute;
      left:50%; top:55%;
      transform: translate(-50%,-50%);
      width:56px; height:56px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, #ff7aa2);
      display:grid;
      place-items:center;
      font-size: 22px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 12px 25px rgba(0,0,0,.12);
      z-index:4;
    }

    /* >>> Letter paper (added) */
    .letterPaper{
      position:absolute;
      left: 14%;
      right: 14%;
      bottom: 10%;
      height: 72%;
      border-radius: 14px;
      background: linear-gradient(180deg, #ffffff, #fff7fb);
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 16px 30px rgba(0,0,0,.10);
      transform: translateY(44%) scale(0.98);
      opacity: 0;
      transition: transform .7s ease, opacity .35s ease;
      overflow:hidden;
      z-index:2;
    }
    .paperLines{
      position:absolute;
      inset: 16px;
      border-radius: 10px;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,122,162,0.0) 0px,
          rgba(255,122,162,0.0) 10px,
          rgba(255,122,162,0.12) 11px,
          rgba(255,122,162,0.12) 12px
        );
      opacity: .9;
    }
    .envelopeOverlay.opened .letterPaper{
      transform: translateY(-8%) scale(1);
      opacity: 1;
    }
    /* <<< end letter paper */

    .envText{
      margin-top: 12px;
      font-weight: 950;
      text-align:center;
      font-size: 14px;
      opacity: .85;
    }
    .envText small{
      display:block;
      font-weight: 800;
      opacity: .7;
      margin-top: 4px;
    }

    .closeRow{
      display:flex;
      justify-content:center;
      margin-top:14px;
    }
    .closeBtn{
      background:#111827;
      color:#fff;
    }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true">
    <div class="blob one"></div>
    <div class="blob two"></div>
    <div class="blob three"></div>
  </div>

  <div class="floaties" id="floaties" aria-hidden="true"></div>

  <canvas id="confetti"></canvas>
  <div class="toast" id="toast"></div>

  <div class="card">
    <div class="topbar">
      <div class="pill" id="attemptsPill">No attempts: <span id="noCount">0</span></div>
      <button class="pill btn" id="musicBtn" type="button">üîá Music: Off</button>
      <div class="pill muted">Tip: try typing <b>CAROL</b> üòÑ</div>
    </div>

    <div class="bear" id="bear" aria-hidden="true">üß∏</div>

    <h1 id="mainText">Carol, would you be my Valentine again this year?</h1>
    <p class="sub">Be honest‚Ä¶ but the ‚ÄúNo‚Äù button is kinda shy üò≥</p>

    <div class="buttons" id="playArea">
      <button id="yesBtn">Yes</button>
      <button id="noBtn" aria-label="No">No</button>
    </div>
  </div>

  <div class="modalOverlay" id="overlay">
    <div class="modal">
      <h2>Congratulations üéâ</h2>
      <p>Wowwww, you have a Valentin! I mean a Lucas!!! Bravo ‚ù§Ô∏è</p>

      <div class="modalGrid">
        <div class="polaroid">
          <img id="photo" src="photo.jpg" alt="A cute memory"
            onerror="this.style.display='none'; this.insertAdjacentHTML('afterend','<div style=&quot;height:260px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,#ffe6ee,#ffd1dc);font-weight:900;&quot;>Add a photo ‚Üí <span style=&quot;opacity:.75;margin-left:6px&quot;>photo.jpg</span> üß∏</div>')" />
          <div class="caption">Our little moment üíû</div>
        </div>

        <div class="scratchWrap" id="scratchWrap">
          <!-- Love letter overlay -->
          <div class="envelopeOverlay" id="envelopeOverlay" role="button" tabindex="0" aria-label="Open the love letter">
            <div>
              <div class="env" aria-hidden="true">
                <div class="envBack"></div>
                <div class="envBody"></div>

                <!-- added paper -->
                <div class="letterPaper" id="letterPaper">
                  <div class="paperLines"></div>
                </div>

                <div class="envFlap"></div>
                <div class="envSeal">üíå</div>
              </div>
              <div class="envText">Tap to open your love letter üíñ<small>(then scratch the secret)</small></div>
            </div>
          </div>

          <h3 class="secretTitle">Scratch to reveal a secret üíå</h3>
          <p class="secretText" id="secretText">
            Date idea: a cozy dinner + petit gateau + a very big hug‚Ä¶ and you pick the movie üçìüéÄ
            <br/><br/>
            PS: You‚Äôre my favorite person. Always. ü´∂
          </p>
          <p class="hint">Scratch the grey area with your finger/mouse ‚ú®</p>

          <canvas id="scratchCanvas"></canvas>
          <div class="scratchDone" id="scratchDone">YAY! Secret revealed üíñ</div>
        </div>
      </div>

      <div class="closeRow">
        <button class="closeBtn" id="closeBtn">Aww ‚ù§Ô∏è</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Settings
    // ---------------------------
    const FLOAT_COUNT = 36;
    const FLOAT_CHARS = ["‚ù§","‚ô°","‚ù•","‚ô•","üíï","üíñ","üíò","üíù","‚ú®","üå∏","ü•∞","üòç","üéÄ","ü´∂","üçì","üêª","üß∏"];
    const NO_TEXT_STEPS = [
      "No",
      "Are you sure? üò≥",
      "Like‚Ä¶ REALLY sure? ü•∫",
      "This is kinda breaking my heart üíî",
      "Last chance‚Ä¶ üò≠",
      "Ok you‚Äôre too fast üò§",
      "Stoppp üò≠üíñ",
      "No has left the chat üí®"
    ];

    // No button catchable eventually
    const CHASE_TO_UNLOCK = 6;
    const UNLOCK_AFTER_MS = 9000;
    const CATCH_WINDOW_MS = 650;

    // ---------------------------
    // Audio (pop + sparkle + background music)
    // ---------------------------
    let audioCtx = null;

    function getAudio(){
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume();
      return audioCtx;
    }

    function playPop(){
      const ac = getAudio();
      const t0 = ac.currentTime;
      const osc = ac.createOscillator();
      const gain = ac.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(260, t0);
      osc.frequency.exponentialRampToValueAtTime(120, t0 + 0.06);
      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(0.55, t0 + 0.012);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.09);
      osc.connect(gain);
      gain.connect(ac.destination);
      osc.start(t0);
      osc.stop(t0 + 0.1);
    }

    function playSparkle(){
      const ac = getAudio();
      const t0 = ac.currentTime;
      const osc = ac.createOscillator();
      const gain = ac.createGain();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(740, t0);
      osc.frequency.exponentialRampToValueAtTime(1180, t0 + 0.08);
      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(0.25, t0 + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
      osc.connect(gain);
      gain.connect(ac.destination);
      osc.start(t0);
      osc.stop(t0 + 0.2);
    }

    // Background music (procedural)
    let musicOn = false;
    let musicGain = null;
    let musicFilter = null;
    let musicTimer = null;

    function playNote(freq, dur = 0.22){
      const ac = getAudio();
      const t0 = ac.currentTime;
      const osc = ac.createOscillator();
      const g = ac.createGain();

      osc.type = "sine";
      osc.frequency.setValueAtTime(freq, t0);

      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.07, t0 + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

      osc.connect(g);
      g.connect(musicFilter);

      osc.start(t0);
      osc.stop(t0 + dur + 0.02);
    }

    function startMusic(){
      const ac = getAudio();

      musicFilter = ac.createBiquadFilter();
      musicFilter.type = "lowpass";
      musicFilter.frequency.setValueAtTime(1100, ac.currentTime);
      musicFilter.Q.setValueAtTime(0.7, ac.currentTime);

      musicGain = ac.createGain();
      musicGain.gain.setValueAtTime(0.0001, ac.currentTime);
      musicGain.gain.exponentialRampToValueAtTime(0.18, ac.currentTime + 0.12);

      musicFilter.connect(musicGain);
      musicGain.connect(ac.destination);

      const notes = [261.63, 293.66, 329.63, 392.00, 440.00]; // C D E G A
      let step = 0;

      musicTimer = setInterval(() => {
        const base = notes[step % notes.length];
        const octave = (Math.random() < 0.2) ? 2 : 1;
        playNote(base * octave, 0.18 + Math.random() * 0.1);
        step++;
      }, 320);
    }

    function stopMusic(){
      const ac = getAudio();
      if (musicTimer) { clearInterval(musicTimer); musicTimer = null; }
      if (musicGain) {
        const t0 = ac.currentTime;
        musicGain.gain.cancelScheduledValues(t0);
        musicGain.gain.setValueAtTime(Math.max(musicGain.gain.value, 0.0001), t0);
        musicGain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
        setTimeout(() => {
          try { musicFilter.disconnect(); } catch(e) {}
          try { musicGain.disconnect(); } catch(e) {}
          musicFilter = null;
          musicGain = null;
        }, 220);
      }
    }

    // ---------------------------
    // Toast
    // ---------------------------
    const toast = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg, ms=1800){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), ms);
    }

    // ---------------------------
    // Floaties
    // ---------------------------
    const floatiesLayer = document.getElementById("floaties");
    function spawnFloaties(){
      floatiesLayer.innerHTML = "";
      for(let i=0;i<FLOAT_COUNT;i++){
        const el = document.createElement("div");
        el.className = "floaty";
        el.textContent = FLOAT_CHARS[Math.floor(Math.random()*FLOAT_CHARS.length)];
        const left = Math.random()*100;
        const size = 14 + Math.random()*22;
        const dur  = 8 + Math.random()*12;
        const delay = Math.random()*10;
        const drift = (Math.random()*110 - 55) + "px";
        const opacity = 0.45 + Math.random()*0.45;

        el.style.left = left + "vw";
        el.style.fontSize = size + "px";
        el.style.animationDuration = dur + "s";
        el.style.animationDelay = (-delay) + "s";
        el.style.setProperty("--drift", drift);
        el.style.opacity = opacity.toFixed(2);
        el.style.setProperty("--dur", dur + "s");

        floatiesLayer.appendChild(el);
      }
    }
    spawnFloaties();
    window.addEventListener("resize", spawnFloaties);

    // ---------------------------
    // Music button
    // ---------------------------
    const musicBtn = document.getElementById("musicBtn");
    musicBtn.addEventListener("click", () => {
      if (!musicOn) {
        musicOn = true;
        startMusic();
        musicBtn.textContent = "üîä Music: On";
        showToast("Music on ‚ú®", 900);
      } else {
        musicOn = false;
        stopMusic();
        musicBtn.textContent = "üîá Music: Off";
        showToast("Music off ü§´", 900);
      }
    });

    // ---------------------------
    // No button stages
    // ---------------------------
    const noBtn = document.getElementById("noBtn");
    const yesBtn = document.getElementById("yesBtn");
    const overlay = document.getElementById("overlay");
    const closeBtn = document.getElementById("closeBtn");
    const playArea = document.getElementById("playArea");
    const noCountEl = document.getElementById("noCount");
    playArea.style.position = "relative";

    let noCaughtOnce = false;
    let chaseCount = 0;
    let noAttempts = 0;
    const unlockAt = Date.now() + UNLOCK_AFTER_MS;

    let evadeTimer = null;
    function scheduleEvade(ms){
      clearTimeout(evadeTimer);
      evadeTimer = setTimeout(()=>{
        if(!noCaughtOnce) moveNoButton();
      }, ms);
    }
    function isCatchableNow(){
      return chaseCount >= CHASE_TO_UNLOCK || Date.now() >= unlockAt;
    }

    function moveNoButton(){
      const areaRect = playArea.getBoundingClientRect();
      const btnRect = noBtn.getBoundingClientRect();
      const pad = 8;
      const maxX = areaRect.width - btnRect.width - pad;
      const maxY = areaRect.height - btnRect.height - pad;
      const x = Math.max(pad, Math.floor(Math.random()*maxX));
      const y = Math.max(pad, Math.floor(Math.random()*maxY));
      noBtn.style.left = x + "px";
      noBtn.style.top = y + "px";
    }

    function updateNoState(){
      noCountEl.textContent = String(noAttempts);
      const idx = Math.min(noAttempts, NO_TEXT_STEPS.length - 1);
      noBtn.textContent = NO_TEXT_STEPS[idx];
      const scale = Math.max(0.55, 1 - noAttempts * 0.06);
      noBtn.style.transform = `scale(${scale})`;

      if(noAttempts >= NO_TEXT_STEPS.length - 1){
        noBtn.style.opacity = "0";
        noBtn.style.pointerEvents = "none";
        showToast("No has disappeared‚Ä¶ interesting üëÄüíñ", 2200);
      }
    }

    function stageA_evade(){
      chaseCount++;
      noCountEl.textContent = String(chaseCount);

      if(!isCatchableNow()){
        moveNoButton();
        if(chaseCount === 1) showToast("Too slow üòà", 900);
        return;
      }

      noBtn.textContent = "Okay okay‚Ä¶ click me üôà";
      showToast("Alright‚Ä¶ you can catch it now üò≥", 1200);
      scheduleEvade(CATCH_WINDOW_MS);
    }

    function handleApproach(e){
      if(noCaughtOnce) return;
      const r = noBtn.getBoundingClientRect();
      const cx = r.left + r.width/2;
      const cy = r.top + r.height/2;
      const dx = e.clientX - cx;
      const dy = e.clientY - cy;
      const dist = Math.hypot(dx, dy);

      if(dist < 85 && !evadeTimer){
        stageA_evade();
        evadeTimer = setTimeout(()=>{ clearTimeout(evadeTimer); evadeTimer = null; }, 250);
      }
    }

    function stageB_evade(){
      if(noAttempts >= NO_TEXT_STEPS.length - 1) return;
      noAttempts++;
      updateNoState();
      moveNoButton();
    }

    noBtn.addEventListener("mouseenter", () => {
      if(!noCaughtOnce) stageA_evade();
      else stageB_evade();
    });

    playArea.addEventListener("mousemove", (e) => {
      if(!noCaughtOnce) handleApproach(e);

      if(noCaughtOnce && noAttempts < NO_TEXT_STEPS.length - 1){
        const btnRect = noBtn.getBoundingClientRect();
        const dx = e.clientX - (btnRect.left + btnRect.width/2);
        const dy = e.clientY - (btnRect.top + btnRect.height/2);
        const dist = Math.hypot(dx, dy);
        if(dist < 90) moveNoButton();
      }
    });

    noBtn.addEventListener("click", (e) => {
      e.preventDefault();
      if(!noCaughtOnce){
        noCaughtOnce = true;
        noAttempts = 1;
        noBtn.textContent = NO_TEXT_STEPS[1];
        noBtn.style.transform = "scale(0.94)";
        playSparkle();
        showToast("You caught it! Now it panics üò≥", 1600);
        noCountEl.textContent = String(noAttempts);
        setTimeout(moveNoButton, 180);
        return;
      }
      stageB_evade();
      showToast("Nice try üòÑ", 900);
    });

    noBtn.addEventListener("touchstart", (e) => {
      e.preventDefault();
      if(!noCaughtOnce) stageA_evade();
      else stageB_evade();
    }, {passive:false});

    setTimeout(() => { moveNoButton(); }, 250);

    // ---------------------------
    // Confetti
    // ---------------------------
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");

    function resizeCanvas(){
      canvas.width = window.innerWidth * devicePixelRatio;
      canvas.height = window.innerHeight * devicePixelRatio;
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    let confettiPieces = [];
    let confettiActive = false;
    let confettiEndTime = 0;

    function rand(min,max){ return Math.random()*(max-min)+min; }
    function launchConfetti(durationMs=2400, count=280){
      confettiPieces = [];
      for(let i=0;i<count;i++){
        confettiPieces.push({
          x: rand(0, window.innerWidth),
          y: rand(-40, -10),
          w: rand(6, 12),
          h: rand(8, 16),
          vx: rand(-2.6, 2.6),
          vy: rand(2.5, 6.8),
          rot: rand(0, Math.PI*2),
          vr: rand(-0.22, 0.22),
          color: Math.random() < 0.5 ? "rgba(255,255,255,0.95)" : "rgba(255,105,180,0.95)"
        });
      }
      confettiActive = true;
      confettiEndTime = performance.now() + durationMs;
      requestAnimationFrame(tickConfetti);
    }
    function tickConfetti(t){
      if(!confettiActive) return;
      ctx.clearRect(0,0, window.innerWidth, window.innerHeight);
      const gravity = 0.06;
      const drag = 0.995;

      for(const p of confettiPieces){
        p.vy += gravity;
        p.vx *= drag;
        p.vy *= drag;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;

        if(p.x < -30) p.x = window.innerWidth + 30;
        if(p.x > window.innerWidth + 30) p.x = -30;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
      }

      const allBelow = confettiPieces.every(p => p.y > window.innerHeight + 60);
      if(t > confettiEndTime || allBelow){
        confettiActive = false;
        ctx.clearRect(0,0, window.innerWidth, window.innerHeight);
        return;
      }
      requestAnimationFrame(tickConfetti);
    }

    // ---------------------------
    // Scratch
    // ---------------------------
    const scratchCanvas = document.getElementById("scratchCanvas");
    const scratchWrap = document.getElementById("scratchWrap");
    const scratchDone = document.getElementById("scratchDone");
    const sctx = scratchCanvas.getContext("2d");
    let scratching = false;
    let scratchCompleted = false;

    function sizeScratchCanvas(){
      const r = scratchWrap.getBoundingClientRect();
      scratchCanvas.width = Math.floor(r.width * devicePixelRatio);
      scratchCanvas.height = Math.floor(r.height * devicePixelRatio);
      scratchCanvas.style.width = r.width + "px";
      scratchCanvas.style.height = r.height + "px";
      sctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);

      sctx.globalCompositeOperation = "source-over";
      sctx.fillStyle = "rgba(180,180,180,0.96)";
      sctx.fillRect(0,0, r.width, r.height);

      sctx.fillStyle = "rgba(255,255,255,0.9)";
      sctx.font = "900 16px system-ui";
      sctx.fillText("SCRATCH ME ‚ú®", 18, 36);

      scratchDone.style.display = "none";
      scratchCompleted = false;
    }

    function scratchAt(x,y){
      const r = scratchWrap.getBoundingClientRect();
      const sx = x - r.left;
      const sy = y - r.top;
      sctx.globalCompositeOperation = "destination-out";
      sctx.beginPath();
      sctx.arc(sx, sy, 18, 0, Math.PI*2);
      sctx.fill();
    }

    function checkScratchProgress(){
      if (scratchCompleted) return;
      const r = scratchWrap.getBoundingClientRect();
      const img = sctx.getImageData(0,0, Math.floor(r.width), Math.floor(r.height)).data;

      let transparent = 0;
      for(let i=3;i<img.length;i+=4*8){
        if(img[i] === 0) transparent++;
      }
      const total = img.length / (4*8);
      const ratio = transparent / total;

      if(ratio > 0.45){
        scratchCompleted = true;
        scratchDone.style.display = "block";
        playSparkle();
        showToast("Secret unlocked üíñ", 1400);
        setTimeout(()=> { sctx.clearRect(0,0, scratchCanvas.width, scratchCanvas.height); }, 280);
      }
    }

    function pointerPos(e){
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      return {x: p.clientX, y: p.clientY};
    }

    function scratchStart(e){
      scratching = true;
      const {x,y} = pointerPos(e);
      scratchAt(x,y);
      e.preventDefault();
    }
    function scratchMove(e){
      if(!scratching) return;
      const {x,y} = pointerPos(e);
      scratchAt(x,y);
      e.preventDefault();
    }
    function scratchEnd(){
      if(!scratching) return;
      scratching = false;
      checkScratchProgress();
    }

    function initScratch(){
      sizeScratchCanvas();
      scratchCanvas.addEventListener("pointerdown", scratchStart);
      scratchCanvas.addEventListener("pointermove", scratchMove);
      scratchCanvas.addEventListener("pointerup", scratchEnd);
      scratchCanvas.addEventListener("pointercancel", scratchEnd);
      scratchCanvas.addEventListener("touchstart", scratchStart, {passive:false});
      scratchCanvas.addEventListener("touchmove", scratchMove, {passive:false});
      scratchCanvas.addEventListener("touchend", scratchEnd);
    }

    // ---------------------------
    // Love letter logic (with paper)
    // ---------------------------
    const envelopeOverlay = document.getElementById("envelopeOverlay");
    let scratchInited = false;
    let envelopeOpened = false;

    function resetEnvelope(){
      envelopeOpened = false;
      envelopeOverlay.classList.remove("opened", "gone");
      envelopeOverlay.style.display = "grid";
      envelopeOverlay.style.pointerEvents = "auto";
      sizeScratchCanvas(); // repaint scratch cover each time modal opens
    }

    function openEnvelope(){
      if (envelopeOpened) return;
      envelopeOpened = true;
      playSparkle();
      if (navigator.vibrate) navigator.vibrate(20);

      envelopeOverlay.classList.add("opened");
      showToast("Open ittt üíå", 900);

      // hide overlay after flap/paper animation
      setTimeout(() => {
        envelopeOverlay.classList.add("gone");
        envelopeOverlay.style.pointerEvents = "none";
      }, 700);

      // enable scratch after envelope starts opening
      if(!scratchInited){
        scratchInited = true;
        setTimeout(initScratch, 50);
      } else {
        setTimeout(sizeScratchCanvas, 80);
      }
    }

    envelopeOverlay.addEventListener("click", openEnvelope);
    envelopeOverlay.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") openEnvelope();
    });

    // ---------------------------
    // Yes click
    // ---------------------------
    yesBtn.addEventListener("click", () => {
      playPop();
      launchConfetti(2400, 280);
      document.body.classList.add("party");
      overlay.style.display = "grid";

      resetEnvelope();

      showToast("YAYYYY üíò", 1200);
      setTimeout(()=>document.body.classList.remove("party"), 2500);
    });

    closeBtn.addEventListener("click", () => { overlay.style.display = "none"; });

    // ---------------------------
    // Easter egg: type CAROL
    // ---------------------------
    let buffer = "";
    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if(k.length !== 1) return;
      buffer = (buffer + k).slice(-10);
      if(buffer.includes("carol")){
        buffer = "";
        playSparkle();
        launchConfetti(3200, 420);
        document.body.classList.add("party");
        showToast("EASTER EGG UNLOCKED üß∏‚ú®üíñ", 2000);
        document.getElementById("bear").textContent = "üß∏üíñüß∏";
        setTimeout(()=>document.body.classList.remove("party"), 3000);
      }
    });
  </script>
</body>
</html>
